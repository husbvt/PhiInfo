name: Build-PhiInfo

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore Dependencies
      run: dotnet restore

    - name: Publish EXE
      run: dotnet publish -c Release -r win-x64 --self-contained true -o ./dist

    - name: Download ClassData TPK
      shell: pwsh
      run: |
        # 使用从 AssetRipper/Tpk v2.0.0 Release 中找到的正确链接
        $url = "https://github.com/AssetRipper/Tpk/releases/download/v2.0.0/classdata.tpk"
        
        Write-Host "Downloading TPK file from Release: $url"
        
        # 增加失败重试逻辑
        $retryCount = 0
        $maxRetries = 2
        $downloadSuccess = $false
        
        while ($retryCount -le $maxRetries -and -not $downloadSuccess) {
          try {
            if ($retryCount -gt 0) {
              Write-Host "Retry attempt $retryCount of $maxRetries..."
              Start-Sleep -Seconds 3
            }
            
            Invoke-WebRequest -Uri $url -OutFile "./dist/classdata.tpk" -UserAgent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" -TimeoutSec 30
            $downloadSuccess = $true
            Write-Host "Download completed successfully."
          }
          catch {
            $retryCount++
            Write-Warning "Download attempt failed: $_"
            if ($retryCount -gt $maxRetries) {
              Write-Error "Failed to download file after $maxRetries attempts."
              exit 1
            }
          }
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PhiInfo-Complete-Package
        path: ./dist
        retention-days: 7
