name: Build-PhiInfo-NightlyLogic

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Publish EXE
      run: dotnet publish -c Release -r win-x64 --self-contained true -o ./dist

    - name: Download Uncompressed TPK
      shell: pwsh
      run: |
        # 对应图片中 Type Tree Tpk 表格里的 Uncompressed 链接
        # 这是 Nightly 自动构建的最完整、未压缩的 TPK 资源
        $url = "https://nightly.link/AssetRipper/Tpk/workflows/type_tree_tpk/master/uncompressed.zip"
        
        Write-Host "Downloading Uncompressed TPK Package..."
        Invoke-WebRequest -Uri $url -OutFile "./tpk_package.zip" -UserAgent "Mozilla/5.0"
        
        # 因为下载的是 .zip 压缩包，需要解压出里面的 classdata.tpk
        Expand-Archive -Path "./tpk_package.zip" -DestinationPath "./tpk_temp"
        
        # 将解压出来的 classdata.tpk 移到程序目录
        Move-Item "./tpk_temp/classdata.tpk" "./dist/classdata.tpk"
        
        Write-Host "Success: classdata.tpk has been integrated."

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PhiInfo-Complete-Package
        path: ./dist
